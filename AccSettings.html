<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pocket Console – Login</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      background: #0b0f14;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: #e8eef6;
    }
    .card {
      width: min(760px, calc(100% - 28px));
      background: #101824;
      border: 1px solid #223044;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      overflow: hidden;
    }
    .header {
      padding: 18px 18px 12px;
      border-bottom: 1px solid #223044;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      letter-spacing: .2px;
    }
    .dot { width: 10px; height: 10px; border-radius: 999px; background: #3ea6ff; }
    .content { padding: 18px; }

    .row { display: flex; align-items: center; gap: 14px; }
    .avatar {
      width: 64px; height: 64px; border-radius: 999px;
      border: 1px solid #2a3b52; background: #0b0f14;
      object-fit: cover;
    }
    .meta { line-height: 1.25; flex: 1; min-width: 0; }
    .name { font-size: 16px; font-weight: 700; margin: 0 0 4px; }
    .email { font-size: 13px; opacity: .85; margin: 0; word-break: break-word; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #2a3b52;
      background: #152235;
      font-size: 12px;
      opacity: .95;
      white-space: nowrap;
    }
    .dotLive {
      width: 8px; height: 8px; border-radius: 999px;
      background: #e85b5b;
      box-shadow: 0 0 0 2px rgba(232,91,91,.15);
    }
    .dotLive.on { background: #40d17a; box-shadow: 0 0 0 2px rgba(64,209,122,.15); }

    .status {
      margin-top: 14px;
      font-size: 13px;
      opacity: .92;
      padding: 10px 12px;
      background: #0b1220;
      border: 1px solid #223044;
      border-radius: 12px;
      line-height: 1.35;
      word-break: break-word;
    }

    .grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .field {
      background: #0b1220;
      border: 1px solid #223044;
      border-radius: 12px;
      padding: 12px;
    }
    .fieldLabel {
      font-size: 12px;
      opacity: .8;
      margin: 0 0 6px;
    }
    .fieldRow {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      word-break: break-all;
      opacity: .95;
    }

    .actions {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    button {
      appearance: none;
      border: 1px solid #2a3b52;
      background: #152235;
      color: #e8eef6;
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 650;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
    }
    button:hover { background: #1b2c45; border-color: #365173; }
    button:active { transform: translateY(1px); }
    button.primary { background: #1a3a5a; border-color: #2d6ea8; }
    button.primary:hover { background: #20476e; }
    button:disabled { opacity: .55; cursor: not-allowed; }

    .hint {
      margin-top: 12px;
      font-size: 12px;
      opacity: .8;
      line-height: 1.35;
    }
    .footer {
      padding: 12px 18px 16px;
      border-top: 1px solid #223044;
      font-size: 12px;
      opacity: .8;
      line-height: 1.35;
    }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>

<body>
  <div class="card">
    <div class="header">
      <div class="brand"><span class="dot"></span> Pocket Console</div>
      <div id="authChip" style="font-size:12px;opacity:.85;">Checking sign-in…</div>
    </div>

    <div class="content">
      <div class="row">
        <img id="avatar" class="avatar" alt="Profile photo" src="" />
        <div class="meta">
          <p id="name" class="name">Not signed in</p>
          <p id="email" class="email">—</p>
        </div>

        <div class="pill" title="Realtime presence (RTDB)">
          <span id="liveDot" class="dotLive"></span>
          <span id="liveText">Offline</span>
        </div>
      </div>

      <div id="status" class="status">Status: Initializing…</div>
      <div id="debug" class="hint">Debug: —</div>

      <div class="grid">
        <div class="field">
          <p class="fieldLabel">Public ID (share-friendly)</p>
          <div class="fieldRow">
            <div id="publicIdText" class="mono">—</div>
            <button id="copyPublicBtn" type="button">Copy</button>
            <button id="sharePublicBtn" type="button">Share</button>
          </div>
        </div>

        <div class="field">
          <p class="fieldLabel">Firebase UID (unique internal user id)</p>
          <div class="fieldRow">
            <div id="uidText" class="mono">—</div>
            <button id="copyUidBtn" type="button">Copy</button>
            <button id="shareUidBtn" type="button">Share</button>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="loginBtn" class="primary">Login with Google</button>
        <button id="logoutBtn">Logout</button>
      </div>

      <div class="hint">
        If you see a Firestore error in Debug, you must enable Firestore and set rules. Presence requires RTDB rules too.
      </div>
    </div>

    <div class="footer">
      Run from a proper origin (Live Server / Hosting), not <code>file://</code>.
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";

    import {
      getAuth,
      GoogleAuthProvider,
      onAuthStateChanged,
      setPersistence,
      browserLocalPersistence,
      signInWithPopup,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    import {
      getFirestore,
      doc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    import {
      getDatabase,
      ref,
      set,
      onValue,
      onDisconnect
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

    // Your config (RTDB URL included)
    const firebaseConfig = {
      apiKey: "AIzaSyANEuAY3tzLEJvpxalLNRMp4BeTTzj25rI",
      authDomain: "pocketconsole-cde70.firebaseapp.com",
      projectId: "pocketconsole-cde70",
      storageBucket: "pocketconsole-cde70.firebasestorage.app",
      messagingSenderId: "85026527206",
      appId: "1:85026527206:web:67bffb25c7f7e059fc2827",
      measurementId: "G-1F476LV4XJ",
      databaseURL: "https://pocketconsole-cde70-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch (_) {}

    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const fs = getFirestore(app);
    const rtdb = getDatabase(app);

    // UI
    const authChip = document.getElementById("authChip");
    const avatarEl = document.getElementById("avatar");
    const nameEl = document.getElementById("name");
    const emailEl = document.getElementById("email");
    const statusEl = document.getElementById("status");
    const debugEl = document.getElementById("debug");

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    const uidText = document.getElementById("uidText");
    const publicIdText = document.getElementById("publicIdText");

    const copyUidBtn = document.getElementById("copyUidBtn");
    const shareUidBtn = document.getElementById("shareUidBtn");
    const copyPublicBtn = document.getElementById("copyPublicBtn");
    const sharePublicBtn = document.getElementById("sharePublicBtn");

    const liveDot = document.getElementById("liveDot");
    const liveText = document.getElementById("liveText");

    const fallbackAvatar =
      "data:image/svg+xml;charset=utf-8," +
      encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
          <rect width="100%" height="100%" fill="#0b0f14"/>
          <circle cx="64" cy="52" r="22" fill="#223044"/>
          <path d="M24 118c8-22 28-34 40-34s32 12 40 34" fill="#223044"/>
        </svg>
      `);

    let currentUid = null;
    let currentPublicId = null;

    function setPresenceBadge(isOnline) {
      liveDot.classList.toggle("on", !!isOnline);
      liveText.textContent = isOnline ? "Online" : "Offline";
    }

    function setBusy(isBusy) {
      loginBtn.disabled = isBusy;
      logoutBtn.disabled = isBusy;

      copyUidBtn.disabled = isBusy || !currentUid;
      shareUidBtn.disabled = isBusy || !currentUid;

      copyPublicBtn.disabled = isBusy || !currentPublicId;
      sharePublicBtn.disabled = isBusy || !currentPublicId;
    }

    function safeText(v, fallback = "—") {
      if (v === null || v === undefined) return fallback;
      const s = String(v).trim();
      return s.length ? s : fallback;
    }

    function getBestPhotoURL(user) {
      if (user?.photoURL) return user.photoURL;
      const providerPhoto = user?.providerData?.find(p => p?.photoURL)?.photoURL;
      return providerPhoto || fallbackAvatar;
    }

    function normalizeGooglePhoto(url) {
      if (typeof url !== "string" || !url.startsWith("http")) return url;
      try {
        const u = new URL(url);
        if (!u.searchParams.has("sz")) u.searchParams.set("sz", "256");
        return u.toString();
      } catch {
        return url;
      }
    }

    function makePublicId(uid) {
      return "PC-" + uid.slice(0, 8).toUpperCase();
    }

    function setLoggedOutUI() {
      authChip.textContent = "Signed out";
      avatarEl.src = fallbackAvatar;
      nameEl.textContent = "Not signed in";
      emailEl.textContent = "—";

      currentUid = null;
      currentPublicId = null;

      uidText.textContent = "—";
      publicIdText.textContent = "—";

      setPresenceBadge(false);

      statusEl.textContent = "Status: Please login.";
      debugEl.textContent = "Debug: —";

      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
      setBusy(false);
    }

    // IMPORTANT: Update UI immediately when user exists
    function setLoggedInUI(user) {
      authChip.textContent = "Signed in";

      avatarEl.src = normalizeGooglePhoto(getBestPhotoURL(user));
      const provider0 = user?.providerData?.[0];

      nameEl.textContent = safeText(user?.displayName || provider0?.displayName, "Google User");
      emailEl.textContent = safeText(user?.email || provider0?.email);

      currentUid = user.uid;
      currentPublicId = makePublicId(user.uid);

      uidText.textContent = currentUid;
      publicIdText.textContent = currentPublicId;

      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
    }

    function showError(prefix, e) {
      const msg = e?.message ? e.message : String(e);
      const code = e?.code ? ` (${e.code})` : "";
      debugEl.textContent = `Debug: ${prefix}${code}: ${msg}`;
    }

    async function upsertUserDoc(user) {
  const provider0 = user?.providerData?.[0];
  const publicId = makePublicId(user.uid);

  const displayName = user.displayName || provider0?.displayName || "Google User";
  const email = user.email || provider0?.email || null;
  const photoURL = user.photoURL || provider0?.photoURL || null;
  const provider = provider0?.providerId || "google";

  // 1) PRIVATE profile (only you can read/write with the new rules)
  await setDoc(doc(fs, "users", user.uid), {
    uid: user.uid,
    publicId,
    displayName,
    email,           // keep email private
    photoURL,
    provider,
    lastLoginAt: serverTimestamp()
  }, { merge: true });

  // 2) PUBLIC profile (everyone signed-in can read, used for searching)
  await setDoc(doc(fs, "publicUsers", user.uid), {
    uid: user.uid,
    publicId,
    displayName,
    photoURL,
    lastLoginAt: serverTimestamp()
  }, { merge: true });
}

    

    function setupPresence(uid) {
      const statusRef = ref(rtdb, `/status/${uid}`);
      const connectedRef = ref(rtdb, ".info/connected");

      onValue(connectedRef, (snap) => {
        const connected = snap.val() === true;

        if (!connected) {
          setPresenceBadge(false);
          return;
        }

        // IMPORTANT: do NOT await here; just schedule operations
        onDisconnect(statusRef).set({ state: "offline", lastChanged: Date.now() })
          .then(() => set(statusRef, { state: "online", lastChanged: Date.now() }))
          .catch((e) => showError("RTDB presence", e));
      });

      onValue(statusRef, (snap) => {
        const val = snap.val();
        setPresenceBadge(val?.state === "online");
      });
    }

    async function copyText(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        try {
          document.execCommand("copy");
          return true;
        } catch {
          return false;
        } finally {
          ta.remove();
        }
      }
    }

    async function shareOrCopy(label, value) {
      const shareData = { title: "Pocket Console", text: `${label}: ${value}`, url: location.href };
      if (navigator.share) {
        try { await navigator.share(shareData); return { ok: true, mode: "share" }; } catch {}
      }
      const ok = await copyText(`${label}: ${value}`);
      return { ok, mode: "copy" };
    }

    copyUidBtn.addEventListener("click", async () => {
      if (!currentUid) return;
      statusEl.textContent = (await copyText(currentUid)) ? "Status: UID copied." : "Status: Copy failed.";
    });

    shareUidBtn.addEventListener("click", async () => {
      if (!currentUid) return;
      const r = await shareOrCopy("My UID", currentUid);
      statusEl.textContent = r.ok
        ? (r.mode === "share" ? "Status: Shared UID." : "Status: Share not supported—copied UID instead.")
        : "Status: Share/copy failed.";
    });

    copyPublicBtn.addEventListener("click", async () => {
      if (!currentPublicId) return;
      statusEl.textContent = (await copyText(currentPublicId)) ? "Status: Public ID copied." : "Status: Copy failed.";
    });

    sharePublicBtn.addEventListener("click", async () => {
      if (!currentPublicId) return;
      const r = await shareOrCopy("My Public ID", currentPublicId);
      statusEl.textContent = r.ok
        ? (r.mode === "share" ? "Status: Shared Public ID." : "Status: Share not supported—copied Public ID instead.")
        : "Status: Share/copy failed.";
    });

    loginBtn.addEventListener("click", async () => {
      setBusy(true);
      statusEl.textContent = "Status: Opening Google sign-in…";
      debugEl.textContent = "Debug: —";
      try {
        await signInWithPopup(auth, provider);
      } catch (e) {
        showError("Auth signInWithPopup", e);
        statusEl.textContent = "Status: Login failed (see Debug).";
      } finally {
        setBusy(false);
      }
    });

    logoutBtn.addEventListener("click", async () => {
      setBusy(true);
      statusEl.textContent = "Status: Signing out…";
      debugEl.textContent = "Debug: —";
      try {
        const u = auth.currentUser;
        if (u) {
          await set(ref(rtdb, `/status/${u.uid}`), { state: "offline", lastChanged: Date.now() })
            .catch(() => {});
        }
        await signOut(auth);
      } catch (e) {
        showError("Auth signOut", e);
        statusEl.textContent = "Status: Logout failed (see Debug).";
      } finally {
        setBusy(false);
      }
    });

    async function init() {
      statusEl.textContent = "Status: Initializing…";
      setBusy(true);

      try {
        await setPersistence(auth, browserLocalPersistence);
      } catch (e) {
        showError("Auth persistence", e);
      }

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          setLoggedOutUI();
          return;
        }

        // 1) show signed in UI immediately
        setLoggedInUI(user);
        setBusy(true);

        // 2) Firestore write (non-blocking UI)
        statusEl.textContent = "Status: Creating/updating your profile…";
        try {
          await upsertUserDoc(user);
          statusEl.textContent = "Status: Profile saved. Setting up presence…";
        } catch (e) {
          showError("Firestore setDoc", e);
          statusEl.textContent = "Status: Signed in, but Firestore profile save failed (see Debug). Setting up presence…";
        }

        // 3) Presence setup (non-blocking)
        try {
          setupPresence(user.uid);
          statusEl.textContent = "Status: Signed in. Presence should show Online when connected.";
        } catch (e) {
          showError("RTDB setupPresence", e);
          statusEl.textContent = "Status: Signed in, but presence setup failed (see Debug).";
        } finally {
          setBusy(false);
        }
      });
    }

    init();
  </script>
</body>
</html>
